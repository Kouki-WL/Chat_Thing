<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1"
  />
  <title>Chat Thing IdentifyUser E2E Test</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; padding: 24px; }
    .card { max-width: 900px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    p { color: #374151; line-height: 1.6; }
    code { background: #f3f4f6; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Chat Thing IdentifyUser E2E Test</h1>
    <p>
      このページは、<code>window.chatThing.identifyUser</code> によるユーザー自動識別のテスト用です。<br />
      仮ユーザー：<strong>ごかんこうき</strong>（ID: <strong>k-gokan@web-life.co.jp</strong>）
    </p>
    <p>
      コンソールを開いて、<code>identifyUser called</code> ログと送信ペイロードを確認してください。<br />
      ウィジェットの設定によっては、名前/メール入力欄が隠れるか、初期値として自動入力されます。
    </p>
  </div>

  <!-- 1) Chat ThingのWidget設定（最小構成。必要に応じてCSS等は本番と同様に追加可） -->
  <script>
    // 必要なら見た目などの設定を追加できる（簡易例）
    window.chatThingConfig = {
      // 表示言語
      locale: "jp",
      // 初回のチップ
      firstMessage: "【テスト】AIサポートをご利用いただけます。"
    };
  </script>

  <!-- 2) Chat Thingのウィジェット本体（テスト用を使用） -->
  <!-- ※ あなたのテスト用Widgetのscriptを貼り付け。IDはそのまま利用してください。 -->
  <script
    src="https://chatthing.ai/chat-widget.js"
    type="text/javascript"
    id="ee4f0166-e22c-42ef-bd62-2c011f120001"
    async
    defer
  ></script>

  <!-- 3) 仮ユーザー情報を安全に埋め込み（本番はサーバ側から埋め込む） -->
  <script>
    // 本番では window.currentUser をサーバ側で安全に埋め込む
    window.currentUser = {
      id: "k-gokan@web-life.co.jp",          // ← IDとしてメールを利用
      name: "ごかんこうき",
      email: "k-gokan@web-life.co.jp"
    };
  </script>

  <!-- 4) Widgetの初期化完了を待って identifyUser を実行（リトライ付きで堅牢に） -->
  <script>
    (function identifyWhenReady(maxRetries = 100, delayMs = 100) {
      const tryIdentify = (retriesLeft) => {
        const api = window.chatThing && window.chatThing.identifyUser;
        if (typeof api === "function") {
          const payload = {
            id: window.currentUser?.id,
            name: window.currentUser?.name,
            email: window.currentUser?.email
          };

          // 型条件を満たすように id or email が入っているかだけ軽くチェック
          if (!payload.id && !payload.email) {
            console.warn("[ChatThing] identifyUser skipped: id or email required.");
            return;
          }

          try {
            console.log("[ChatThing] identifyUser called with:", payload);
            window.chatThing.identifyUser(payload);
          } catch (e) {
            console.error("[ChatThing] identifyUser error:", e);
          }
          return;
        }

        if (retriesLeft <= 0) {
          console.error("[ChatThing] identifyUser not available: timed out waiting widget init.");
          return;
        }
        setTimeout(() => tryIdentify(retriesLeft - 1), delayMs);
      };

      // DOMContentLoaded後の方が安定
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => tryIdentify(maxRetries));
      } else {
        tryIdentify(maxRetries);
      }
    })();
  </script>
</body>
</html>
